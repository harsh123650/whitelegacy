{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel – Dairy App</title>
    <link rel="stylesheet" href="{% static 'dairyapp/css/admin.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
</head>
<body>

<header>
    <h1>Welcome to Admin Panel</h1>
</header>

<div class="container">

    <!-- 📦 Latest Milk Delivery -->
    <div class="panel">
        <h2 class="section-title">📦 Latest Milk Delivery</h2>
        {% if latest_delivery %}
            <p><strong>Customer ID:</strong> {{ latest_delivery.customer_id }}</p>
            <p><strong>Date:</strong> {{ latest_delivery.date }}</p>
            <p><strong>Time:</strong> {{ latest_delivery.time }}</p>
            <form method="post" action="{% url 'delete_delivery' latest_delivery.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Delete Delivery</button>
            </form>
        {% else %}
            <p>No delivery data submitted yet.</p>
        {% endif %}
    </div>

    <!-- 🐃 Buffalo Activity Logs -->
    <div class="panel">
        <h2 class="section-title">🐃 Buffalo Activity Logs</h2>

        <h3>🥛 Milking Logs</h3>
        <ul>
            {% for m in today_milking %}
                <li>
                    Buffalo {{ m.buffalo_number }} – {{ m.milk_time }} – {{ m.milk_quantity }} L (by {{ m.submitted_by.username }})
                    <form method="post" action="{% url 'delete_milking' m.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </li>
            {% empty %}
                <li>No milking logs today.</li>
            {% endfor %}
        </ul>

        <h3>💊 Health Logs</h3>
        <ul>
            {% for h in today_health %}
                <li>
                    Buffalo {{ h.buffalo_number }} – {{ h.health_notes }} (by {{ h.submitted_by.username }})
                    <form method="post" action="{% url 'delete_health' h.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </li>
            {% empty %}
                <li>No health logs today.</li>
            {% endfor %}
        </ul>
    </div>

    <!-- 👤 Create New User -->
    <div class="panel">
        <h2 class="section-title">👤 Create New User</h2>
        <form method="post" action="{% url 'create_user' %}">
            {% csrf_token %}
            <div class="form-group">
                {{ form.username.label_tag }} {{ form.username }}
            </div>
            <div class="form-group">
                {{ form.password.label_tag }} {{ form.password }}
            </div>
            <div class="form-group">
                {{ form.role.label_tag }} {{ form.role }}
            </div>
            <input type="submit" value="Create User">
        </form>
    </div>

    <!-- 📋 Users Management -->
    <div class="panel">
        <h2 class="section-title">📋 Users Management</h2>
        <button onclick="openUserModal()" class="btn btn-primary">Manage Users</button>
    </div>

    <!-- 👥 User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserModal()">&times;</span>
            <h3>Manage Users</h3>

            <h4>👷 Staff</h4>
            <ul>
                {% for user in staff_list %}
                    <li>
                        {{ user.user.username }} ({{ user.custom_id }})
                        <form method="post" action="{% url 'delete_user' user.user.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </li>
                {% empty %}
                    <li>No staff users found.</li>
                {% endfor %}
            </ul>

            <h4>👨‍🌾 Workers</h4>
            <ul>
                {% for user in worker_list %}
                    <li>
                        {{ user.user.username }} ({{ user.custom_id }})
                        <form method="post" action="{% url 'delete_user' user.user.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </li>
                {% empty %}
                    <li>No worker users found.</li>
                {% endfor %}
            </ul>

            <h4>🧑‍🤝‍🧑 Customers</h4>
            <ul>
                {% for user in customer_list %}
                    <li>
                        {{ user.user.username }} ({{ user.custom_id }})
                        <form method="post" action="{% url 'delete_user' user.user.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </li>
                {% empty %}
                    <li>No customer users found.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- 📊 Charts -->
    <div class="chart-container">
        <h3>Milk Deliveries per Day</h3>
        <canvas id="deliveryChart"></canvas>
    </div>

    <div class="chart-container" style="margin-top: 40px;">
        <h3>Buffalo Milking per Day</h3>
        <canvas id="milkingChart"></canvas>
    </div>

    <!-- 🔚 Footer -->
    <div class="footer-links">
        <a href="{% url 'logout' %}">Logout</a>
    </div>
</div>

<!-- ✅ JSON Chart Data -->
<script id="chart-data" type="application/json">
{
    "labels": {{ labels|safe }},
    "delivery": {{ delivery_data|safe }},
    "milking": {{ milking_data_chart|safe }}
}
</script>

<!-- 📈 Chart.js -->
<script>
    const chartData = JSON.parse(document.getElementById('chart-data').textContent);
    new Chart(document.getElementById('deliveryChart'), {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Milk Deliveries',
                data: chartData.delivery,
                backgroundColor: 'rgba(66, 165, 245, 0.7)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Milk Deliveries Per Day' }
            }
        }
    });

    new Chart(document.getElementById('milkingChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Milking Litres',
                data: chartData.milking,
                borderColor: 'rgba(76, 175, 80, 1)',
                fill: false,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Milking Quantity Per Day' }
            }
        }
    });

    function openUserModal() {
        document.getElementById("userModal").style.display = "block";
    }
    function closeUserModal() {
        document.getElementById("userModal").style.display = "none";
    }
</script>

</body>
</html>
